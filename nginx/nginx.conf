worker_processes auto;

events {
  worker_connections  65535;
  multi_accept on;
}

http {
  include       mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout  30s;

  # Light log to keep CPU lower
  log_format short '$remote_addr $status $request_time "$request"';
  access_log /var/log/nginx/access.log short;
  error_log  /var/log/nginx/error.log warn;

  server_tokens off;

  # Upstreams
  upstream httpbin { server tf-httpbin:8080; }

  # Rate limiting zone (e.g., 2 req/s)
  limit_req_zone $binary_remote_addr zone=rl_zone:10m rate=2r/s;

  # Map host to bucket
  map $host $bucket {
    default                 ok;
    "~^ok-\d+\."            ok;
    "~^redirect-\d+\."      redirect;
    "~^rl-\d+\."            rl;
    "~^delay(\d+)s-\d+\."   delay;
    "~^big-\d+\."           big;
    "~^err-\d+\."           err;
    "~^waf-\d+\."           waf;
  }

  # Simple “WAF-like” block rules (simulate false-positives/blocks)
  map $args $waf_block {
    default 0;
    "~*(union(\s|%20)+select|select(\s|%20)+from|<script|onerror=)" 1;
  }

  # Extract delay seconds from host for delay bucket
  map $host $delay_sec {
    default 1;
    ~^delay(\d+)s- $1;
  }

  server {
    listen 80 reuseport;

    # Common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Bucket routing
    location / {
      set $waf_final 0;

      if ($bucket = waf) { set $waf_final $waf_block; }

      if ($waf_final = 1) { return 403; }

      if ($bucket = waf) { proxy_pass http://httpbin; break; }

      # Basic behaviors
      if ($bucket = ok)       { proxy_pass http://httpbin/get;           break; }
      if ($bucket = redirect) { proxy_pass http://httpbin/redirect/3;    break; }
      if ($bucket = big)      { proxy_pass http://httpbin/bytes/1048576; break; }
      if ($bucket = err)      { proxy_pass http://httpbin/status/500;    break; }

      # Rate limit
      if ($bucket = rl) {
        limit_req zone=rl_zone burst=5 nodelay;
        proxy_pass http://httpbin/status/200;
        break;
      }

      # Delay bucket: host like delay1s-001.x.x.x.x.sslip.io
      if ($bucket ~* "^delay") {
        proxy_pass http://httpbin/delay/$delay_sec;
        break;
      }

      # Fallback (shouldn’t hit often)
      proxy_pass http://httpbin/get;
    }
  }
}